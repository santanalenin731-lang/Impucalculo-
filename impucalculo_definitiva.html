<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Impucalculo | Gestión Fiscal RD 2025-2026</title>

    <!-- Meta/SEO -->
    <meta name="description"
        content="Calculadora fiscal avanzada para trabajadores en República Dominicana (2025-2026). Gestión de ISR, TSS y acumulados mensuales.">
    <link rel="icon" type="image/jpeg" href="logo.jpg">
    <link rel="apple-touch-icon" href="logo.jpg">

    <!-- Fonts & Scripts -->
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700;800&display=swap"
        rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Outfit', 'sans-serif'] },
                    colors: {
                        dr: {
                            blue: '#0038A8',
                            red: '#CE1126',
                            white: '#FFFFFF',
                            slate: {
                                50: '#F8FAFC',
                                100: '#F1F5F9',
                                200: '#E2E8F0',
                                800: '#1E293B',
                                900: '#0F172A'
                            }
                        }
                    },
                    animation: {
                        'fade-in': 'fadeIn 0.5s ease-out forwards',
                        'slide-up': 'slideUp 0.6s cubic-bezier(0.16, 1, 0.3, 1) forwards',
                    },
                    keyframes: {
                        fadeIn: { '0%': { opacity: '0' }, '100%': { opacity: '1' } },
                        slideUp: { '0%': { opacity: '0', transform: 'translateY(20px)' }, '100%': { opacity: '1', transform: 'translateY(0)' } }
                    }
                }
            }
        }
    </script>

    <style>
        :root {
            --dr-blue: #0038A8;
            --dr-red: #CE1126;
        }

        body {
            background-color: #F8FAFC;
            background-image: radial-gradient(circle at 2px 2px, #E2E8F0 1px, transparent 0);
            background-size: 32px 32px;
        }

        .glass {
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.4);
        }

        .neo-shadow {
            box-shadow: 0 10px 30px -10px rgba(0, 56, 168, 0.15);
        }

        .btn-gradient-blue {
            background: linear-gradient(135deg, #0038A8, #1E40AF);
            transition: all 0.3s ease;
        }

        .btn-gradient-blue:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 24px -8px rgba(0, 56, 168, 0.4);
        }

        .progress-bar-glow {
            box-shadow: 0 0 15px rgba(0, 56, 168, 0.2);
        }

        /* Parallax & Scroll Effects */
        .parallax-block {
            transition: opacity 1.2s cubic-bezier(0.2, 0.8, 0.2, 1);
            will-change: transform, opacity;
        }

        .scroll-reveal {
            opacity: 0;
            transform: translateY(40px);
        }

        .scroll-reveal.visible {
            opacity: 1;
            transform: translateY(0);
        }

        .tilt-card {
            transition: transform 0.2s ease-out, box-shadow 0.3s ease;
            transform-style: preserve-3d;
            perspective: 1000px;
        }

        .tilt-card:hover {
            box-shadow: 0 30px 60px -15px rgba(0, 56, 168, 0.25);
        }

        .tilt-content {
            transform: translateZ(30px);
        }

        /* Custom scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #F1F5F9;
        }

        ::-webkit-scrollbar-thumb {
            background: #CBD5E1;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #0038A8;
        }
    </style>
</head>

<body class="min-h-screen flex flex-col font-sans text-dr-slate-900">

    <!-- Header -->
    <header class="sticky top-0 z-50 glass border-b border-dr-slate-100 py-4">
        <div class="max-w-6xl mx-auto px-6 flex items-center justify-between">
            <div class="flex items-center gap-4">
                <div
                    class="w-12 h-12 rounded-2xl bg-dr-white flex items-center justify-center neo-shadow border border-dr-slate-100 overflow-hidden">
                    <img src="logo.jpg" alt="Logo" class="w-8 h-8 object-contain"
                        onerror="this.src='https://img.icons8.com/ios-filled/100/0038A8/calculator.png'">
                </div>
                <div>
                    <h1 class="text-2xl font-extrabold tracking-tight leading-none">
                        <span class="text-dr-red">Impu</span><span class="text-dr-blue">calculo</span>
                    </h1>
                    <p class="text-[10px] uppercase tracking-[0.2em] font-bold text-dr-red mt-1">Gestión Fiscal RD
                        2025-2026
                    </p>
                </div>
            </div>
            <div class="hidden md:flex items-center gap-6">
                <div class="text-right">
                    <p class="text-xs font-bold text-dr-slate-800 uppercase tracking-widest leading-none">Ley de
                        Ingresos</p>
                    <p class="text-[10px] text-dr-slate-400 mt-1 font-medium">República Dominicana</p>
                </div>
                <div class="w-px h-8 bg-dr-slate-200"></div>
                <div class="bg-dr-blue/5 px-4 py-2 rounded-xl">
                    <span id="current-date-display" class="text-xs font-bold text-dr-blue tracking-tighter uppercase">05
                        ENE 2025</span>
                </div>
            </div>
        </div>
    </header>

    <main class="max-w-6xl mx-auto px-6 py-10 w-full flex-grow">
        <div class="grid lg:grid-cols-12 gap-10">

            <!-- Left Column: Input Panel -->
            <div id="block-registro" class="lg:col-span-5 space-y-8 parallax-block scroll-reveal">
                <div class="glass rounded-[2rem] p-8 neo-shadow border border-white tilt-card">
                    <div class="tilt-content">
                        <div class="flex items-center gap-3 mb-8">
                            <div class="w-2 h-8 bg-dr-red rounded-full"></div>
                            <h2 class="text-xl font-extrabold text-dr-slate-800 tracking-tight">Registro de Ingreso</h2>
                        </div>

                        <form id="tax-form" class="space-y-8">
                            <!-- Frequency Selection -->
                            <div class="space-y-4">
                                <label
                                    class="block text-xs font-black text-dr-slate-400 uppercase tracking-widest">Frecuencia
                                    de Cobro</label>
                                <div class="grid grid-cols-3 gap-4">
                                    <label
                                        class="relative flex flex-col items-center gap-3 p-4 rounded-2xl border-2 border-dr-slate-100 hover:border-dr-blue/30 cursor-pointer transition-all has-[:checked]:border-dr-blue has-[:checked]:bg-dr-blue has-[:checked]:shadow-lg has-[:checked]:shadow-dr-blue/20 group">
                                        <input type="radio" name="freq" value="semanal" class="peer hidden" checked>
                                        <span
                                            class="text-[10px] font-black uppercase tracking-widest text-dr-slate-400 peer-checked:text-white">Semanal</span>
                                    </label>
                                    <label
                                        class="relative flex flex-col items-center gap-3 p-4 rounded-2xl border-2 border-dr-slate-100 hover:border-dr-blue/30 cursor-pointer transition-all has-[:checked]:border-dr-blue has-[:checked]:bg-dr-blue has-[:checked]:shadow-lg has-[:checked]:shadow-dr-blue/20 group">
                                        <input type="radio" name="freq" value="quincenal" class="peer hidden">
                                        <span
                                            class="text-[10px] font-black uppercase tracking-widest text-dr-slate-400 peer-checked:text-white">Quincenal</span>
                                    </label>
                                    <label
                                        class="relative flex flex-col items-center gap-3 p-4 rounded-2xl border-2 border-dr-slate-100 hover:border-dr-blue/30 cursor-pointer transition-all has-[:checked]:border-dr-blue has-[:checked]:bg-dr-blue has-[:checked]:shadow-lg has-[:checked]:shadow-dr-blue/20 group">
                                        <input type="radio" name="freq" value="mensual" class="peer hidden">
                                        <span
                                            class="text-[10px] font-black uppercase tracking-widest text-dr-slate-400 peer-checked:text-white">Mensual</span>
                                    </label>
                                </div>
                            </div>
                    </div>

                    <!-- Date Selection -->
                    <div class="space-y-3">
                        <label for="input-date"
                            class="block text-xs font-black text-dr-slate-400 uppercase tracking-widest">Fecha
                            de
                            Pago</label>
                        <input type="date" id="input-date" required
                            class="w-full px-5 py-4 bg-dr-slate-50 border-2 border-dr-slate-100 rounded-2xl text-dr-slate-900 font-bold focus:border-dr-blue focus:ring-4 focus:ring-dr-blue/5 outline-none transition-all">
                    </div>

                    <!-- Salary Input -->
                    <div class="space-y-3 relative">
                        <label for="gross-salary"
                            class="block text-xs font-black text-dr-slate-400 uppercase tracking-widest">Sueldo
                            Bruto Percibido</label>
                        <div class="relative">
                            <div class="absolute inset-y-0 left-0 pl-6 flex items-center pointer-events-none">
                                <span class="text-dr-blue font-black text-lg">RD$</span>
                            </div>
                            <input type="number" id="gross-salary" step="0.01" min="0" placeholder="0.00" required
                                class="w-full pl-16 pr-6 py-5 bg-dr-slate-50 border-2 border-dr-slate-100 rounded-[1.5rem] text-2xl font-black text-dr-slate-900 placeholder:text-dr-slate-200 focus:border-dr-blue focus:ring-8 focus:ring-dr-blue/5 outline-none transition-all">
                        </div>
                    </div>

                    <button type="submit"
                        class="w-full py-5 rounded-[1.5rem] btn-gradient-blue text-white font-black text-lg uppercase tracking-widest">
                        Procesar Cálculo
                    </button>
                    </form>
                </div>

                <!-- Ad/Info Card -->
                <div class="glass rounded-[2rem] p-8 neo-shadow border border-white relative overflow-hidden group">
                    <div
                        class="absolute top-0 right-0 w-32 h-32 bg-dr-blue opacity-5 rounded-full -mr-16 -mt-16 group-hover:scale-110 transition-transform duration-700">
                    </div>
                    <h3 class="text-lg font-bold mb-4 flex items-center gap-2 text-dr-blue">
                        <svg class="w-5 h-5 text-dr-red" fill="currentColor" viewBox="0 0 20 20">
                            <path
                                d="M5 3a2 2 0 00-2 2v2a2 2 0 002 2h2a2 2 0 002-2V5a2 2 0 00-2-2H5zM5 11a2 2 0 00-2 2v2a2 2 0 002 2h2a2 2 0 002-2v-2a2 2 0 00-2-2H5zM11 5a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V5zM11 13a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z">
                            </path>
                        </svg>
                        Seguridad Social 2025
                    </h3>
                    <p class="text-sm text-dr-slate-600 font-medium leading-relaxed">
                        Se aplica una deducción automática del <span class="text-dr-blue font-bold">5.91%</span> sobre
                        el
                        sueldo bruto:
                        <br>• <span class="font-bold text-dr-slate-800">3.04%</span> Seguro Familiar de Salud (SFS)
                        <br>• <span class="font-bold text-dr-slate-800">2.87%</span> Adm. de Fondos de Pensiones (AFP)
                    </p>
                </div>
            </div>

            <!-- Right Column: Results & History -->
            <div class="lg:col-span-7 space-y-32">

                <!-- NEW SECTION: Resumen del Mes Actual -->
                <div class="parallax-block scroll-reveal">
                    <div id="block-resumen"
                        class="glass rounded-[2rem] p-8 neo-shadow border border-white overflow-hidden relative tilt-card">
                        <div class="tilt-content">
                            <div class="absolute top-0 right-0 p-8 opacity-[0.03]">
                                <svg class="w-32 h-32" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd"
                                        d="M6 2a1 1 0 00-1 1v1H4a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2h-1V3a1 1 0 10-2 0v1H7V3a1 1 0 00-1-1zm0 5a1 1 0 000 2h8a1 1 0 100-2H6z"
                                        clip-rule="evenodd"></path>
                                </svg>
                            </div>

                            <div
                                class="flex flex-col md:flex-row md:items-center justify-between gap-6 mb-8 relative z-10">
                                <div class="flex items-center gap-3">
                                    <div class="w-10 h-10 rounded-xl bg-dr-blue/10 flex items-center justify-center">
                                        <svg class="w-6 h-6 text-dr-blue" fill="none" stroke="currentColor"
                                            viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                d="M11 3.055A9.001 9.001 0 1020.945 13H11V3.055z"></path>
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                d="M20.488 9H15V3.512A9.025 9.025 0 0120.488 9z"></path>
                                        </svg>
                                    </div>
                                    <h2 class="text-xl font-extrabold text-dr-slate-800 tracking-tight">Resumen del
                                        Mes Actual
                                    </h2>
                                </div>
                                <span id="label-mes-actual"
                                    class="px-4 py-2 bg-dr-blue text-white text-[10px] font-black uppercase tracking-widest rounded-full shadow-lg shadow-dr-blue/20">ENERO
                                    2025</span>
                            </div>

                            <div class="grid sm:grid-cols-2 gap-6 mb-8">
                                <div
                                    class="bg-dr-slate-50 rounded-2xl p-6 border border-dr-slate-100 transition-all hover:bg-white hover:neo-shadow group">
                                    <p class="text-[10px] font-black text-dr-slate-400 uppercase tracking-widest mb-2">
                                        Ingreso
                                        Neto Acumulado</p>
                                    <p id="mtd-net" class="text-2xl font-black text-dr-blue transition-colors">
                                        RD$ 0.00</p>
                                </div>
                                <div
                                    class="bg-dr-slate-50 rounded-2xl p-6 border border-dr-slate-100 transition-all hover:bg-white hover:neo-shadow group">
                                    <p class="text-[10px] font-black text-dr-slate-400 uppercase tracking-widest mb-2">
                                        ISR
                                        Retenido Acumulado</p>
                                    <p id="mtd-isr" class="text-2xl font-black text-dr-red">RD$ 0.00</p>
                                </div>
                            </div>

                            <!-- Progress Limit -->
                            <div class="space-y-4 pt-2">
                                <div class="flex items-center justify-between">
                                    <span class="text-xs font-bold text-dr-slate-600">Proximidad al Límite Exento
                                        Monthly</span>
                                    <span class="text-[10px] font-black text-dr-slate-400 uppercase tracking-widest">RD$
                                        34,685.00</span>
                                </div>
                                <div
                                    class="h-4 w-full bg-dr-slate-100 rounded-full overflow-hidden border border-dr-slate-200 p-1">
                                    <div id="mtd-progress-bar"
                                        class="h-full bg-dr-blue rounded-full transition-all duration-1000 ease-in-out progress-bar-glow"
                                        style="width: 0%"></div>
                                </div>
                                <div class="flex justify-between">
                                    <p id="mtd-progress-text" class="text-[10px] font-bold text-dr-slate-400">0% del
                                        umbral
                                        alcanzado</p>
                                    <p id="mtd-status"
                                        class="text-[10px] font-black text-dr-blue uppercase tracking-widest animate-pulse">
                                        Exento de ISR</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- History Section -->
                <div class="parallax-block scroll-reveal">
                    <div id="block-historial"
                        class="glass rounded-[2rem] neo-shadow border border-white overflow-hidden tilt-card">
                        <div class="tilt-content">
                            <div class="p-8 border-b border-dr-slate-100 flex items-center justify-between">
                                <div class="flex items-center gap-3">
                                    <div
                                        class="w-10 h-10 rounded-xl bg-dr-slate-100 flex items-center justify-center text-dr-slate-400">
                                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                        </svg>
                                    </div>
                                    <h2 class="text-xl font-extrabold text-dr-slate-800 tracking-tight">Cronología
                                        de Cálculos
                                    </h2>
                                </div>
                                <button id="clear-history"
                                    class="px-5 py-2.5 bg-dr-red text-white text-[10px] font-black uppercase tracking-widest rounded-xl hover:scale-105 active:scale-95 transition-all shadow-lg shadow-dr-red/20">Limpiar
                                    Todo</button>
                            </div>

                            <div class="overflow-x-auto">
                                <table class="w-full text-left">
                                    <thead>
                                        <tr class="bg-dr-slate-50/50">
                                            <th
                                                class="px-8 py-5 text-[10px] font-black text-dr-slate-400 uppercase tracking-[0.2em]">
                                                Fecha</th>
                                            <th
                                                class="px-8 py-5 text-[10px] font-black text-dr-slate-400 uppercase tracking-[0.2em]">
                                                Bruto</th>
                                            <th
                                                class="px-8 py-5 text-[10px] font-black text-dr-slate-400 uppercase tracking-[0.2em]">
                                                Retenciones</th>
                                            <th
                                                class="px-8 py-5 text-[10px] font-black text-dr-slate-400 uppercase tracking-[0.2em] text-right">
                                                Neto Percibido</th>
                                        </tr>
                                    </thead>
                                    <tbody id="history-rows" class="divide-y divide-dr-slate-100">
                                        <!-- Filas dinámicas -->
                                    </tbody>
                                </table>
                                <div id="empty-state" class="py-20 text-center space-y-4">
                                    <div
                                        class="inline-flex items-center justify-center w-20 h-20 rounded-full bg-dr-slate-50 text-dr-slate-200">
                                        <svg class="w-10 h-10" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                d="M9 13h6m-3-3v6m5 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z">
                                            </path>
                                        </svg>
                                    </div>
                                    <p class="text-sm font-bold text-dr-slate-400 uppercase tracking-widest">No se
                                        han
                                        registrado operaciones</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

            </div>
        </div>
    </main>

    <!-- Footer -->
    <footer class="py-10 glass border-t border-dr-slate-100 mt-20">
        <div class="max-w-6xl mx-auto px-6 flex flex-col md:flex-row items-center justify-between gap-6">
            <div class="text-center md:text-left">
                <p class="text-xs font-bold text-dr-slate-400 uppercase tracking-[0.2em]">Plataforma Fiscal Premium</p>
                <p class="text-sm font-extrabold text-dr-slate-800 mt-1">Creado por: <span class="text-dr-blue">Lenin
                        Santana de Jesus</span></p>
            </div>
            <div class="px-6 py-3 bg-dr-white neo-shadow rounded-2xl border border-dr-slate-100">
                <p class="text-xs font-black text-dr-slate-800 uppercase tracking-tighter">Año de Implementación: <span
                        class="text-dr-red">2025</span></p>
            </div>
        </div>
    </footer>

    <!-- Templates -->
    <template id="row-template">
        <tr class="group hover:bg-dr-blue/[0.02] transition-colors">
            <td class="px-8 py-6">
                <p class="text-xs font-black text-dr-slate-900 mb-1 date-val">05 ENE 2025</p>
                <span
                    class="freq-tag px-2 py-0.5 bg-dr-slate-100 text-[9px] font-black text-dr-slate-500 uppercase rounded-md">MENSUAL</span>
            </td>
            <td class="px-8 py-6">
                <p class="text-sm font-black text-dr-slate-800 gross-val">RD$ 0.00</p>
            </td>
            <td class="px-8 py-6">
                <div class="space-y-1">
                    <p class="text-[10px] font-bold text-dr-slate-400 flex items-center justify-between">TSS: <span
                            class="text-dr-red tss-val">RD$ 0.00</span></p>
                    <p class="text-[10px] font-bold text-dr-slate-400 flex items-center justify-between">ISR: <span
                            class="text-dr-red isr-val">RD$ 0.00</span></p>
                </div>
            </td>
            <td class="px-8 py-6 text-right">
                <p class="text-lg font-black text-dr-blue net-val leading-none">RD$ 0.00</p>
                <div class="accum-badge mt-2 hidden">
                    <span class="px-2 py-0.5 bg-dr-blue/10 text-dr-blue text-[8px] font-black uppercase rounded">Mes
                        Acumulado</span>
                </div>
            </td>
        </tr>
    </template>

    <script>
        /**
         * LÓGICA DE NEGOCIO - IMPUCALCULO 2025
         * @author Lenin Santana de Jesus
         */

        const CONFIG = {
            MONTHLY_EXEMPT: 34685.00,
            ANNUAL_EXEMPT: 416220.00,
            TSS_RATE: 0.0591, // 3.04% SFS + 2.87% AFP
            BRACKETS: [
                { limit: 867123.01, rate: 0.25, fixed: 79776.00, base: 867123.00 },
                { limit: 624329.01, rate: 0.20, fixed: 31216.00, base: 624329.00 },
                { limit: 416220.01, rate: 0.15, fixed: 0, base: 416220.00 }
            ]
        };

        const STORAGE_KEY = 'impucalculo_data_v2';
        let state = JSON.parse(localStorage.getItem(STORAGE_KEY)) || {
            records: []
        };

        const fmt = new Intl.NumberFormat('es-DO', { style: 'currency', currency: 'DOP' });
        const fmtDate = (d) => {
            const date = new Date(d + 'T00:00:00');
            return date.toLocaleDateString('es-DO', { day: '2-digit', month: 'short', year: 'numeric' }).toUpperCase();
        };

        const getMonthYear = (d) => {
            const date = new Date(d + 'T00:00:00');
            return `${date.getMonth() + 1}-${date.getFullYear()}`;
        };

        // DOM elements
        const elements = {
            form: document.getElementById('tax-form'),
            dateInput: document.getElementById('input-date'),
            salaryInput: document.getElementById('gross-salary'),
            currentDateDisplay: document.getElementById('current-date-display'),
            mtdNet: document.getElementById('mtd-net'),
            mtdIsr: document.getElementById('mtd-isr'),
            mtdProgressBar: document.getElementById('mtd-progress-bar'),
            mtdProgressText: document.getElementById('mtd-progress-text'),
            mtdStatus: document.getElementById('mtd-status'),
            labelMesActual: document.getElementById('label-mes-actual'),
            historyRows: document.getElementById('history-rows'),
            emptyState: document.getElementById('empty-state'),
            btnClear: document.getElementById('clear-history')
        };

        // Initialize state
        const init = () => {
            const today = new Date().toISOString().split('T')[0];
            elements.dateInput.value = today;
            elements.currentDateDisplay.innerText = fmtDate(today);
            updateDashboard();
            renderHistory();
        };

        const calculateAnnualISR = (annualTaxable) => {
            if (annualTaxable <= CONFIG.ANNUAL_EXEMPT) return 0;
            const bracket = CONFIG.BRACKETS.find(b => annualTaxable >= b.limit);
            if (!bracket) {
                // Should only be the first bracket (15%)
                const b = CONFIG.BRACKETS[2];
                return (annualTaxable - b.base) * b.rate;
            }
            return bracket.fixed + ((annualTaxable - bracket.base) * bracket.rate);
        };

        const updateDashboard = () => {
            const now = new Date();
            const currentMonthYear = `${now.getMonth() + 1}-${now.getFullYear()}`;

            // Filter records for current month
            const currentMonthRecords = state.records.filter(r => getMonthYear(r.date) === currentMonthYear);

            const totalGross = currentMonthRecords.reduce((sum, r) => sum + r.gross, 0);
            const totalIsr = currentMonthRecords.reduce((sum, r) => sum + r.isr, 0);
            const totalTss = totalGross * CONFIG.TSS_RATE;
            const totalTaxable = totalGross - totalTss;
            const totalNet = totalGross - totalTss - totalIsr;

            elements.mtdNet.innerText = fmt.format(totalNet);
            elements.mtdIsr.innerText = fmt.format(totalIsr);
            elements.labelMesActual.innerText = now.toLocaleDateString('es-DO', { month: 'long', year: 'numeric' }).toUpperCase();

            const progress = Math.min((totalTaxable / CONFIG.MONTHLY_EXEMPT) * 100, 100);
            elements.mtdProgressBar.style.width = `${progress}%`;
            elements.mtdProgressText.innerText = `${progress.toFixed(1)}% del umbral alcanzado`;

            if (totalTaxable > CONFIG.MONTHLY_EXEMPT) {
                elements.mtdStatus.innerText = 'Sujeto a Retención';
                elements.mtdStatus.classList.replace('text-dr-blue', 'text-dr-red');
                elements.mtdProgressBar.classList.replace('bg-dr-blue', 'bg-dr-red');
            } else {
                elements.mtdStatus.innerText = 'Exento de ISR';
                elements.mtdStatus.classList.replace('text-dr-red', 'text-dr-blue');
                elements.mtdProgressBar.classList.replace('bg-dr-red', 'bg-dr-blue');
            }
        };

        const renderHistory = () => {
            elements.historyRows.innerHTML = '';
            if (state.records.length === 0) {
                elements.emptyState.classList.remove('hidden');
                return;
            }
            elements.emptyState.classList.add('hidden');

            // Sort by date desc
            const sorted = [...state.records].sort((a, b) => new Date(b.date) - new Date(a.date));

            sorted.forEach(record => {
                const template = document.getElementById('row-template').content.cloneNode(true);
                template.querySelector('.date-val').innerText = fmtDate(record.date);
                template.querySelector('.freq-tag').innerText = record.freq;
                template.querySelector('.gross-val').innerText = fmt.format(record.gross);
                template.querySelector('.tss-val').innerText = fmt.format(record.tss);
                template.querySelector('.isr-val').innerText = fmt.format(record.isr);
                template.querySelector('.net-val').innerText = fmt.format(record.net);

                // If it's the current month, show the badge
                const now = new Date();
                if (getMonthYear(record.date) === `${now.getMonth() + 1}-${now.getFullYear()}`) {
                    template.querySelector('.accum-badge').classList.remove('hidden');
                }

                elements.historyRows.appendChild(template);
            });
        };

        elements.form.addEventListener('submit', (e) => {
            e.preventDefault();

            const date = elements.dateInput.value;
            const gross = parseFloat(elements.salaryInput.value);
            const freq = Array.from(document.getElementsByName('freq')).find(r => r.checked).value.toUpperCase();

            const monthYear = getMonthYear(date);

            // 1. Get previous cumulative data for THIS SPECIFIC MONTH
            const prevInMonth = state.records.filter(r => getMonthYear(r.date) === monthYear);
            const prevGross = prevInMonth.reduce((sum, r) => sum + r.gross, 0);
            const prevIsrPaid = prevInMonth.reduce((sum, r) => sum + r.isr, 0);

            // 2. New Cumulative Totals
            const currentGrossTotal = prevGross + gross;
            const currentTssTotal = currentGrossTotal * CONFIG.TSS_RATE;
            const currentTaxableTotal = currentGrossTotal - currentTssTotal;

            // 3. Current Entry Values
            const tss = gross * CONFIG.TSS_RATE;

            let totalIsrDue = 0;
            if (currentTaxableTotal > CONFIG.MONTHLY_EXEMPT) {
                // Projection to annual to get the correct bracket/rate
                totalIsrDue = calculateAnnualISR(currentTaxableTotal * 12) / 12;
            }

            // Adjust current entry ISR to match cumulative expectation
            const isr = Math.max(0, totalIsrDue - prevIsrPaid);
            const net = gross - tss - isr;

            // Save record
            state.records.unshift({
                id: Date.now(),
                date,
                freq,
                gross,
                tss,
                isr,
                net
            });

            localStorage.setItem(STORAGE_KEY, JSON.stringify(state));

            // UI Feedback
            updateDashboard();
            renderHistory();
            elements.salaryInput.value = '';

            // Scroll to dashboard
            document.getElementById('block-resumen').scrollIntoView({ behavior: 'smooth', block: 'center' });
        });

        elements.btnClear.addEventListener('click', () => {
            if (confirm('¿Está seguro de que desea eliminar todo el historial y reiniciar los acumulados?')) {
                state.records = [];
                localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
                updateDashboard();
                renderHistory();
            }
        });

        // Trigger date change update
        elements.dateInput.addEventListener('change', () => {
            elements.currentDateDisplay.innerText = fmtDate(elements.dateInput.value);
        });


        // Parallax Effect Engine - Ultra Fluid Version
        const initParallax = () => {
            const blocks = document.querySelectorAll('.parallax-block');

            // 1. Efficient Scroll Reveal using Intersection Observer
            const revealObserver = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        entry.target.classList.add('visible');
                    }
                });
            }, { threshold: 0.1 });

            blocks.forEach(block => revealObserver.observe(block));

            // 2. High-Performance Parallax Loop
            let ticking = false;

            const updateParallax = () => {
                const scrollY = window.pageYOffset;
                const winH = window.innerHeight;

                blocks.forEach((block) => {
                    if (!block.classList.contains('visible')) return;

                    const rect = block.getBoundingClientRect();
                    const centerX = winH / 2;
                    const speed = 0.1; // Suavizado

                    const movement = (centerX - rect.top) * speed;
                    block.style.transform = `translate3d(0, ${movement}px, 0)`;
                });

                ticking = false;
            };

            window.addEventListener('scroll', () => {
                if (!ticking) {
                    window.requestAnimationFrame(updateParallax);
                    ticking = true;
                }
            }, { passive: true });

            updateParallax(); // Initial positioning
        };

        // Mouse Parallax (Tilt Effect)
        const initTilt = () => {
            const cards = document.querySelectorAll('.tilt-card');

            cards.forEach(card => {
                card.addEventListener('mousemove', (e) => {
                    const rect = card.getBoundingClientRect();
                    const x = e.clientX - rect.left;
                    const y = e.clientY - rect.top;

                    const centerX = rect.width / 2;
                    const centerY = rect.height / 2;

                    const rotateX = ((y - centerY) / centerY) * -10; // Sensibilidad X
                    const rotateY = ((x - centerX) / centerX) * 10;  // Sensibilidad Y

                    card.style.transform = `rotateX(${rotateX}deg) rotateY(${rotateY}deg) scale(1.02)`;
                });

                card.addEventListener('mouseleave', () => {
                    card.style.transform = `rotateX(0) rotateY(0) scale(1)`;
                });
            });
        };

        init();
        initParallax();
        initTilt();
    </script>
</body>

</html>
```