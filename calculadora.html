<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Impucalculo | Gestión Fiscal RD 2025-2026</title>

    <!-- Meta/SEO -->
    <meta name="description"
        content="Calculadora fiscal avanzada para trabajadores en República Dominicana (2025-2026). Gestión de ISR, TSS y acumulados mensuales.">
    <link rel="icon" type="image/png" href="logo_new.png">
    <link rel="apple-touch-icon" href="logo_new.png">

    <meta name="keywords"
        content="calculadora fiscal, impuestos rd, retenciones de ley, isr, afp, ars, nomina, salario neto, republica dominicana">
    <meta name="author" content="Impucálculo">
    <link rel="canonical" href="https://impucalculo.com/calculadora.html">

    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://impucalculo.com/calculadora.html">
    <meta property="og:title" content="Impucalculo | Gestión Fiscal RD 2025-2026">
    <meta property="og:description"
        content="Calculadora fiscal avanzada para trabajadores en República Dominicana (2025-2026). Gestión de ISR, TSS y acumulados mensuales.">
    <meta property="og:image" content="https://impucalculo.com/logo_new.png">

    <!-- Twitter -->
    <meta property="twitter:card" content="summary_large_image">
    <meta property="twitter:url" content="https://impucalculo.com/calculadora.html">
    <meta property="twitter:title" content="Impucalculo | Gestión Fiscal RD 2025-2026">
    <meta property="twitter:description"
        content="Calculadora fiscal avanzada para trabajadores en República Dominicana (2025-2026). Gestión de ISR, TSS y acumulados mensuales.">
    <meta property="twitter:image" content="https://impucalculo.com/logo_new.png">

    <!-- Fonts & Scripts -->
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700;800&display=swap"
        rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Outfit', 'sans-serif'] },
                    colors: {
                        dr: {
                            blue: '#0038A8',
                            red: '#CE1126',
                            white: '#FFFFFF',
                            slate: {
                                50: '#F8FAFC',
                                100: '#F1F5F9',
                                200: '#E2E8F0',
                                800: '#1E293B',
                                900: '#0F172A'
                            }
                        }
                    },
                    animation: {
                        'fade-in': 'fadeIn 0.5s ease-out forwards',
                        'slide-up': 'slideUp 0.6s cubic-bezier(0.16, 1, 0.3, 1) forwards',
                        'infinite-scroll': 'infinite-scroll 40s linear infinite',
                    },
                    keyframes: {
                        fadeIn: { '0%': { opacity: '0' }, '100%': { opacity: '1' } },
                        slideUp: { '0%': { opacity: '0', transform: 'translateY(20px)' }, '100%': { opacity: '1', transform: 'translateY(0)' } },
                        'infinite-scroll': {
                            '0%': { transform: 'translateX(0)' },
                            '100%': { transform: 'translateX(-100%)' }
                        }
                    }
                }
            }
        }
    </script>

    <style>
        :root {
            --dr-blue: #0038A8;
            --dr-red: #CE1126;
        }

        body {
            background-color: #F8FAFC;
            background-image: radial-gradient(circle at 2px 2px, #E2E8F0 1px, transparent 0);
            background-size: 32px 32px;
        }

        .glass {
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.4);
        }

        .neo-shadow {
            box-shadow: 0 10px 30px -10px rgba(0, 56, 168, 0.15);
        }

        .btn-gradient-blue {
            background: linear-gradient(135deg, #0038A8, #1E40AF);
            transition: all 0.3s ease;
        }

        .btn-gradient-blue:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 24px -8px rgba(0, 56, 168, 0.4);
        }

        .progress-bar-glow {
            box-shadow: 0 0 15px rgba(0, 56, 168, 0.2);
        }

        /* Parallax & Scroll Effects */
        .parallax-block {
            transition: opacity 1.2s cubic-bezier(0.2, 0.8, 0.2, 1);
            will-change: transform, opacity;
        }

        .scroll-reveal {
            opacity: 1;
            transform: translateY(0);
        }

        .tilt-card {
            transition: transform 0.2s ease-out, box-shadow 0.3s ease;
            transform-style: preserve-3d;
            perspective: 1000px;
        }

        .tilt-card:hover {
            box-shadow: 0 30px 60px -15px rgba(0, 56, 168, 0.25);
        }

        .tilt-content {
            transform: translateZ(30px);
        }

        /* Custom scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #F1F5F9;
        }

        ::-webkit-scrollbar-thumb {
            background: #CBD5E1;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #0038A8;
        }
    </style>
    <!-- Firebase Analytics -->
    <script type="module" src="js/firebase-analytics.js"></script>
</head>

<body class="min-h-screen flex flex-col font-sans text-dr-slate-900">

    <!-- Header -->
    <header class="sticky top-0 z-50 glass border-b border-dr-slate-100 py-4">
        <div class="max-w-6xl mx-auto px-6 flex items-center justify-between">
            <a href="index.html"
                class="flex items-center gap-4 cursor-pointer transition-transform hover:scale-105 active:scale-95"
                aria-label="Ir a Inicio">
                <div class="w-[100px] h-[100px] flex items-center justify-center">
                    <img src="logo_new.png" alt="Logo" class="w-[100px] h-[100px] object-contain drop-shadow-md"
                        onerror="this.src='https://img.icons8.com/ios-filled/100/0038A8/calculator.png'">
                </div>
                <div>
                    <h1 class="text-2xl font-extrabold tracking-tight leading-none">
                        <span class="text-dr-red">Impu</span><span class="text-dr-blue">calculo</span>
                    </h1>
                    <p class="text-[10px] uppercase tracking-[0.2em] font-bold mt-1">
                        <span class="text-dr-blue">Gestión Fiscal</span> <span class="text-dr-red">RD 2025-2026</span>
                    </p>
                </div>
            </a>
            <div class="flex items-center gap-2 md:gap-4">
                <button id="btn-sugerencias"
                    class="flex items-center gap-1 md:gap-2 px-3 md:px-5 py-2.5 rounded-xl btn-gradient-blue text-white text-[10px] md:text-xs font-bold uppercase tracking-wider md:tracking-widest transition-all hover:scale-105 active:scale-90 active:translate-y-1 shadow-lg shadow-dr-blue/20"
                    aria-label="Dejar sugerencias">
                    <svg class="w-3 h-3 md:w-4 md:h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z">
                        </path>
                    </svg>
                    <span class="hidden sm:inline">Sugerencias</span>
                </button>
                <div class="hidden md:block w-px h-8 bg-dr-slate-200"></div>
                <div class="hidden md:block text-right">
                    <p class="text-xs font-bold text-dr-red uppercase tracking-widest leading-none">Ley de
                        Ingresos</p>
                    <p class="text-[10px] text-dr-red mt-1 font-medium">República Dominicana</p>
                </div>
                <div class="hidden lg:block w-px h-8 bg-dr-slate-200"></div>

                <!-- Botón de Ajustes (Sueldo Fijo) -->
                <button onclick="openFixedSalaryModal()"
                    class="flex-shrink-0 p-2 bg-dr-blue/5 rounded-xl border border-dr-blue/10 hover:bg-dr-blue/10 transition-colors group"
                    title="Configurar Sueldo Fijo">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2"
                        stroke="currentColor"
                        class="w-5 h-5 text-dr-blue group-hover:rotate-90 transition-transform duration-500">
                        <path stroke-linecap="round" stroke-linejoin="round"
                            d="M9.594 3.94c.09-.542.56-.94 1.11-.94h2.593c.55 0 1.02.398 1.11.94l.213 1.281c.063.374.313.686.645.87.074.04.147.083.22.127.324.196.72.257 1.075.124l1.217-.456a1.125 1.125 0 011.37.49l1.296 2.247a1.125 1.125 0 01-.26 1.431l-1.003.827c-.293.24-.438.613-.431.992a6.759 6.759 0 010 .255c-.007.378.138.75.43.99l1.005.828c.424.35.534.954.26 1.43l-1.298 2.247a1.125 1.125 0 01-1.369.491l-1.217-.456c-.355-.133-.75-.072-1.076.124a6.57 6.57 0 01-.22.128c-.331.183-.581.495-.644.869l-.213 1.28c-.09.543-.56.941-1.11.941h-2.594c-.55 0-1.02-.398-1.11-.94l-.213-1.281c-.062-.374-.312-.686-.644-.87a6.52 6.52 0 01-.22-.127c-.325-.196-.72-.257-1.076-.124l-1.217.456a1.125 1.125 0 01-1.369-.49l-1.297-2.247a1.125 1.125 0 01.26-1.431l1.004-.827c.292-.24.437-.613.43-.992a6.932 6.932 0 010-.255c.007-.378-.138-.75-.43-.99l-1.004-.828a1.125 1.125 0 01-.26-1.43l1.297-2.247a1.125 1.125 0 011.37-.491l1.216.456c.356.133.751.072 1.076-.124.072-.044.146-.087.22-.128.332-.183.582-.495.644-.869l.214-1.281z" />
                        <path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                    </svg>
                </button>
            </div>
        </div>
    </header>

    <main class="max-w-7xl mx-auto px-4 sm:px-6 py-8 w-full flex-grow">
        <div class="grid grid-cols-1 md:grid-cols-12 gap-8">

            <!-- Left Column: Input Panel -->
            <div id="block-registro" class="md:col-span-5 space-y-8 parallax-block">
                <div class="glass rounded-[2rem] p-8 neo-shadow border border-white tilt-card">
                    <div class="tilt-content">
                        <div class="flex items-center gap-3 mb-8">
                            <div class="w-2 h-8 bg-dr-red rounded-full"></div>
                            <h2 class="text-xl font-extrabold tracking-tight"><span class="text-dr-red">Registro</span>
                                <span class="text-dr-blue">de Ingreso</span>
                            </h2>
                        </div>

                        <form id="tax-form" class="space-y-8">
                            <!-- Frequency Selection -->
                            <div class="space-y-4">
                                <label
                                    class="block text-xs font-black text-dr-slate-400 uppercase tracking-widest">Frecuencia
                                    de Cobro</label>
                                <div class="grid grid-cols-3 gap-4">
                                    <label
                                        class="relative flex flex-col items-center gap-3 p-4 rounded-2xl border-2 border-dr-slate-100 hover:border-dr-blue/30 cursor-pointer transition-all has-[:checked]:border-dr-blue has-[:checked]:bg-dr-blue has-[:checked]:shadow-lg has-[:checked]:shadow-dr-blue/20 group">
                                        <input type="radio" name="freq" value="semanal" class="peer hidden" checked>
                                        <span
                                            class="text-[10px] font-black uppercase tracking-widest text-dr-slate-400 peer-checked:text-white">Semanal</span>
                                    </label>
                                    <label
                                        class="relative flex flex-col items-center gap-3 p-4 rounded-2xl border-2 border-dr-slate-100 hover:border-dr-blue/30 cursor-pointer transition-all has-[:checked]:border-dr-blue has-[:checked]:bg-dr-blue has-[:checked]:shadow-lg has-[:checked]:shadow-dr-blue/20 group">
                                        <input type="radio" name="freq" value="quincenal" class="peer hidden">
                                        <span
                                            class="text-[10px] font-black uppercase tracking-widest text-dr-slate-400 peer-checked:text-white">Quincenal</span>
                                    </label>
                                    <label
                                        class="relative flex flex-col items-center gap-3 p-4 rounded-2xl border-2 border-dr-slate-100 hover:border-dr-blue/30 cursor-pointer transition-all has-[:checked]:border-dr-blue has-[:checked]:bg-dr-blue has-[:checked]:shadow-lg has-[:checked]:shadow-dr-blue/20 group">
                                        <input type="radio" name="freq" value="mensual" class="peer hidden">
                                        <span
                                            class="text-[10px] font-black uppercase tracking-widest text-dr-slate-400 peer-checked:text-white">Mensual</span>
                                    </label>
                                </div>
                            </div>
                            <!-- Date Selection -->
                            <div class="space-y-3">
                                <label for="input-date"
                                    class="block text-xs font-black text-dr-slate-400 uppercase tracking-widest pl-1">Fecha
                                    de
                                    Pago</label>
                                <div class="relative group">
                                    <!-- Custom Display Input (Visible) -->
                                    <div
                                        class="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none z-20">
                                        <svg class="w-5 h-5 text-dr-blue" fill="none" stroke="currentColor"
                                            viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z">
                                            </path>
                                        </svg>
                                    </div>
                                    <input type="text" id="display-date" readonly
                                        class="w-full pl-12 pr-4 py-4 bg-dr-slate-50 border-2 border-dr-slate-100 rounded-2xl text-lg font-bold text-dr-slate-900 focus:border-dr-blue outline-none transition-all cursor-pointer group-hover:border-dr-blue/30"
                                        placeholder="DD/MM/YYYY">

                                    <!-- Actual Date Input (Invisible but Clickable) -->
                                    <input type="date" id="input-date" required
                                        class="absolute inset-0 w-full h-full opacity-0 cursor-pointer z-10">
                                </div>
                                <p class="text-[10px] font-bold text-dr-slate-400 pl-1 uppercase tracking-wider">
                                    Formato: Día / Mes / Año
                                </p>
                            </div>


                            <div class="space-y-6">
                                <div class="space-y-3">
                                    <label for="weekly-income" id="income-label"
                                        class="block text-xs font-black text-dr-blue uppercase tracking-widest">Ingreso
                                        Semanal Bruto</label>
                                    <div class="relative">
                                        <div
                                            class="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none">
                                            <span class="text-dr-blue font-bold">RD$</span>
                                        </div>
                                        <input type="number" id="weekly-income" step="0.01" min="0"
                                            placeholder="Ej: 15,000.00" required
                                            class="w-full pl-12 pr-4 py-4 bg-white border-2 border-dr-blue-100 rounded-2xl text-xl font-black text-dr-slate-900 focus:border-dr-blue outline-none transition-all">
                                    </div>
                                    <p id="income-help" class="text-[10px] text-dr-slate-400 font-bold">Monto total
                                        semanal según tu
                                        volante de pago.</p>
                                </div>



                            </div>

                            <button type="submit"
                                class="w-full py-5 rounded-[1.5rem] btn-gradient-blue text-white font-black text-lg uppercase tracking-widest">
                                Procesar Cálculo
                            </button>
                        </form>
                    </div>
                </div>

                <!-- Ad/Info Card -->
                <div class="glass rounded-[2rem] p-8 neo-shadow border border-white relative overflow-hidden group">
                    <div
                        class="absolute top-0 right-0 w-32 h-32 bg-dr-blue opacity-5 rounded-full -mr-16 -mt-16 group-hover:scale-110 transition-transform duration-700">
                    </div>
                    <h3 class="text-lg font-bold mb-4 flex items-center gap-2 text-dr-blue">
                        <svg class="w-5 h-5 text-dr-red" fill="currentColor" viewBox="0 0 20 20">
                            <path
                                d="M5 3a2 2 0 00-2 2v2a2 2 0 002 2h2a2 2 0 002-2V5a2 2 0 00-2-2H5zM5 11a2 2 0 00-2 2v2a2 2 0 002 2h2a2 2 0 002-2v-2a2 2 0 00-2-2H5zM11 5a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V5zM11 13a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z">
                            </path>
                        </svg>
                        <span class="text-dr-red">Seguridad Social</span> <span class="text-dr-blue">2025-2026</span>
                    </h3>
                    <p class="text-sm text-dr-slate-600 font-medium leading-relaxed">
                        Se aplica una deducción automática del <span class="text-dr-blue font-bold">5.91%</span> sobre
                        el
                        sueldo bruto:
                        <br>• <span class="font-bold text-dr-slate-800">3.04%</span> Seguro Familiar de Salud (ARS)
                        <br>• <span class="font-bold text-dr-slate-800">2.87%</span> Adm. de Fondos de Pensiones (AFP)
                    </p>
                </div>
            </div>

            <!-- Right Column: Results & History -->
            <div class="md:col-span-7 space-y-12">

                <!-- NEW SECTION: Resumen del Mes Actual -->
                <div class="parallax-block scroll-reveal">
                    <div id="block-resumen"
                        class="glass rounded-[2rem] p-8 neo-shadow border border-white overflow-hidden relative tilt-card">
                        <div class="tilt-content">
                            <div class="absolute top-0 right-0 p-8 opacity-[0.03]">
                                <svg class="w-32 h-32" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd"
                                        d="M6 2a1 1 0 00-1 1v1H4a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2h-1V3a1 1 0 10-2 0v1H7V3a1 1 0 00-1-1zm0 5a1 1 0 000 2h8a1 1 0 100-2H6z"
                                        clip-rule="evenodd"></path>
                                </svg>
                            </div>

                            <div
                                class="flex flex-col md:flex-row md:items-center justify-between gap-6 mb-8 relative z-10">
                                <div class="flex items-center gap-3">
                                    <div class="w-10 h-10 rounded-xl bg-dr-blue/10 flex items-center justify-center">
                                        <svg class="w-6 h-6 text-dr-blue" fill="none" stroke="currentColor"
                                            viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                d="M11 3.055A9.001 9.001 0 1020.945 13H11V3.055z"></path>
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                d="M20.488 9H15V3.512A9.025 9.025 0 0120.488 9z"></path>
                                        </svg>
                                    </div>
                                    <h2 class="text-xl font-extrabold tracking-tight"><span
                                            class="text-dr-red">Resumen</span> <span class="text-dr-blue">del Mes
                                            Actual</span></h2>
                                </div>
                                <span id="label-mes-actual"
                                    class="px-4 py-2 bg-dr-blue text-white text-[10px] font-black uppercase tracking-widest rounded-full shadow-lg shadow-dr-blue/20">FEBRERO
                                    2026</span>
                            </div>

                            <div class="space-y-4">
                                <div
                                    class="bg-dr-slate-50/50 rounded-2xl p-6 border border-dr-slate-100 transition-all hover:bg-white">
                                    <div class="flex justify-between items-center mb-4">
                                        <span class="text-xs font-black text-dr-slate-400 uppercase tracking-widest">AFP
                                            Acumulado</span>
                                        <span id="mtd-afp" class="text-lg font-black text-dr-slate-800">RD$ 0.00</span>
                                    </div>
                                    <div class="flex justify-between items-center mb-4">
                                        <span class="text-xs font-black text-dr-slate-400 uppercase tracking-widest">ARS
                                            Acumulado</span>
                                        <span id="mtd-ars" class="text-lg font-black text-dr-slate-800">RD$ 0.00</span>
                                    </div>
                                    <div class="h-px bg-dr-slate-200 mb-4"></div>
                                    <div class="flex justify-between items-center">
                                        <span class="text-xs font-black text-dr-red uppercase tracking-widest">ISR
                                            Retenido</span>
                                        <span id="mtd-isr" class="text-lg font-black text-dr-red">RD$ 0.00</span>
                                    </div>
                                </div>

                                <div
                                    class="bg-dr-blue rounded-3xl p-8 text-white shadow-xl shadow-dr-blue/30 relative overflow-hidden group">
                                    <div
                                        class="absolute top-0 right-0 w-32 h-32 bg-white/10 rounded-full -mr-16 -mt-16 group-hover:scale-110 transition-transform duration-700">
                                    </div>
                                    <p class="text-[10px] font-black uppercase tracking-[0.2em] opacity-80 mb-1">Total
                                        Neto Recibido (Mes)</p>
                                    <p id="mtd-net" class="text-3xl font-black">RD$ 0.00</p>
                                    <div class="mt-4 pt-4 border-t border-white/10 flex justify-between items-center">
                                        <span class="text-[9px] font-bold opacity-70 uppercase">Base Imponible</span>
                                        <span id="mtd-taxable" class="text-xs font-black opacity-90">RD$ 0.00</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Progress Limit -->
                        <div class="space-y-4 pt-12">
                            <div class="flex items-center justify-between">
                                <span class="text-sm font-bold text-dr-slate-600">Proximidad al Límite Exento
                                    (Mensual)</span>
                            </div>
                            <div
                                class="h-4 w-full bg-dr-slate-100 rounded-full overflow-hidden border border-dr-slate-200 p-1">
                                <div id="mtd-progress-bar"
                                    class="h-full bg-dr-blue rounded-full transition-all duration-1000 ease-in-out progress-bar-glow"
                                    style="width: 0%"></div>
                            </div>
                            <div class="flex justify-between">
                                <p id="mtd-progress-text" class="text-xs font-bold text-dr-slate-400">0% del umbral
                                    alcanzado</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- History Section -->
                <div class="parallax-block scroll-reveal">
                    <div id="block-historial"
                        class="glass rounded-[2rem] neo-shadow border border-white overflow-hidden tilt-card">
                        <div class="tilt-content">
                            <div class="p-8 border-b border-dr-slate-100 flex items-center justify-between">
                                <div class="flex items-center gap-3">
                                    <div
                                        class="w-10 h-10 rounded-xl bg-dr-slate-100 flex items-center justify-center text-dr-slate-400">
                                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                        </svg>
                                    </div>
                                    <h2 class="text-xl font-extrabold tracking-tight"><span
                                            class="text-dr-red">Cronología</span> <span class="text-dr-blue">de
                                            Cálculos</span></h2>
                                </div>
                                <button id="clear-history"
                                    class="px-5 py-2.5 bg-dr-red text-white text-[10px] font-black uppercase tracking-widest rounded-xl hover:scale-105 active:scale-95 transition-all shadow-lg shadow-dr-red/20">Limpiar
                                    Todo</button>
                            </div>

                            <div class="overflow-x-auto">
                                <table class="w-full text-left">
                                    <thead>
                                        <tr class="bg-dr-slate-50/50">
                                            <th
                                                class="px-8 py-5 text-[10px] font-black text-dr-slate-400 uppercase tracking-[0.2em]">
                                                Fecha</th>
                                            <th
                                                class="px-8 py-5 text-[10px] font-black text-dr-slate-400 uppercase tracking-[0.2em]">
                                                Bruto</th>
                                            <th
                                                class="px-8 py-5 text-[10px] font-black text-dr-slate-400 uppercase tracking-[0.2em]">
                                                Retenciones</th>
                                            <th
                                                class="px-8 py-5 text-[10px] font-black text-dr-slate-400 uppercase tracking-[0.2em] text-right">
                                                Acción</th>
                                        </tr>
                                    </thead>
                                    <tbody id="history-rows" class="divide-y divide-dr-slate-100">
                                        <!-- Filas dinámicas -->
                                    </tbody>
                                </table>
                                <div id="empty-state" class="py-20 text-center space-y-4">
                                    <div
                                        class="inline-flex items-center justify-center w-20 h-20 rounded-full bg-dr-slate-50 text-dr-slate-200">
                                        <svg class="w-10 h-10" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                d="M9 13h6m-3-3v6m5 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z">
                                            </path>
                                        </svg>
                                    </div>
                                    <p class="text-sm font-bold text-dr-slate-400 uppercase tracking-widest">No se han
                                        registrado operaciones</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

        </div>

        <!-- Metodología de Cálculo -->
        <section id="metodologia" class="mt-32 space-y-16 parallax-block scroll-reveal">
            <div class="text-center space-y-4">
                <div
                    class="inline-flex px-3 py-1 bg-dr-blue/10 text-dr-blue text-[10px] font-black uppercase tracking-widest rounded-full mb-2">
                    Transparencia Fiscal</div>
                <h2 class="text-4xl font-black text-dr-slate-800 tracking-tight">Metodología de Cálculo Fiscal</h2>
                <p class="text-dr-slate-500 font-medium max-w-2xl mx-auto">Entiende el proceso detallado que realiza el
                    sistema para garantizar que tus retenciones de ISR y TSS cumplan con las normativas actuales.</p>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
                <!-- Paso 1 -->
                <div class="glass rounded-[2rem] p-10 neo-shadow border border-white tilt-card">
                    <div class="tilt-content space-y-6">
                        <div
                            class="w-14 h-14 rounded-2xl bg-dr-blue text-white flex items-center justify-center font-black text-2xl shadow-xl shadow-dr-blue/20">
                            1</div>
                        <div>
                            <h3 class="text-xl font-bold text-dr-slate-800 mb-3">Sueldo Neto Gravable</h3>
                            <p class="text-sm text-dr-slate-600 leading-relaxed font-medium">
                                Calculamos tu ingreso neto real restando las deducciones de Seguridad Social al sueldo
                                bruto percibido.
                                <br><br>
                                <span
                                    class="inline-flex items-center gap-2 text-dr-blue font-bold bg-dr-blue/5 px-2 py-1 rounded-lg text-xs">
                                    <span class="w-1.5 h-1.5 rounded-full bg-dr-blue"></span> 3.04% ARS (Salud)
                                </span>
                                <br>
                                <span
                                    class="inline-flex items-center gap-2 text-dr-blue font-bold bg-dr-blue/5 px-2 py-1 rounded-lg text-xs mt-2">
                                    <span class="w-1.5 h-1.5 rounded-full bg-dr-blue"></span> 2.87% AFP (Pensiones)
                                </span>
                            </p>
                        </div>
                    </div>
                </div>

                <!-- Paso 2 -->
                <div class="glass rounded-[2rem] p-10 neo-shadow border border-white tilt-card">
                    <div class="tilt-content space-y-6">
                        <div
                            class="w-14 h-14 rounded-2xl bg-dr-blue text-white flex items-center justify-center font-black text-2xl shadow-xl shadow-dr-blue/20">
                            2</div>
                        <div>
                            <h3 class="text-xl font-bold text-dr-slate-800 mb-3">Proyección Anual</h3>
                            <p class="text-sm text-dr-slate-600 leading-relaxed font-medium">
                                El sistema anualiza tus ingresos (Neto x 12) para ubicarte dentro de la escala
                                progresiva de la DGII.
                                <br><br>
                                Esto permite aplicar la retención exacta basada en tu flujo de ingresos acumulado y
                                proyectado.
                            </p>
                        </div>
                    </div>
                </div>

                <!-- Paso 3 -->
                <div class="glass rounded-[2rem] p-10 neo-shadow border border-white tilt-card">
                    <div class="tilt-content space-y-6">
                        <div
                            class="w-14 h-14 rounded-2xl bg-dr-blue text-white flex items-center justify-center font-black text-2xl shadow-xl shadow-dr-blue/20">
                            3</div>
                        <div>
                            <h3 class="text-xl font-bold text-dr-slate-800 mb-3">Escala Progresiva</h3>
                            <p class="text-sm text-dr-slate-600 leading-relaxed font-medium">
                                Aplicamos la retención sobre el excedente del exento mensual de <span
                                    class="text-dr-red font-bold">RD$ 34,685.00</span>:
                                <br><br>
                                <span class="flex justify-between border-b border-dr-slate-100 pb-1 mb-1">
                                    <span class="font-bold">15%</span><span class="text-xs">Excedente 1er tramo</span>
                                </span>
                                <span class="flex justify-between border-b border-dr-slate-100 pb-1 mb-1">
                                    <span class="font-bold">20%</span><span class="text-xs">Excedente 2do tramo</span>
                                </span>
                                <span class="flex justify-between">
                                    <span class="font-bold">25%</span><span class="text-xs">Excedente 3er tramo</span>
                                </span>
                            </p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Nota Técnica TSS -->
            <div
                class="glass rounded-[3rem] p-10 neo-shadow border border-dr-blue/20 bg-dr-blue/[0.03] relative overflow-hidden group">
                <div
                    class="absolute top-0 right-0 w-64 h-64 bg-dr-blue/5 rounded-full -mr-32 -mt-32 blur-3xl group-hover:bg-dr-blue/10 transition-all duration-700">
                </div>
                <div class="relative z-10 flex flex-col md:flex-row items-center gap-10">
                    <div
                        class="w-24 h-24 shrink-0 rounded-[2rem] bg-dr-white flex items-center justify-center neo-shadow border border-dr-slate-100">
                        <svg class="w-12 h-12 text-dr-blue" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z" />
                        </svg>
                    </div>
                    <div>
                        <div class="flex items-center gap-3 mb-3">
                            <span class="w-2 h-6 bg-dr-blue rounded-full"></span>
                            <h4 class="text-2xl font-black text-dr-slate-800 tracking-tight">Nota Técnica: Tope TSS
                                Observado</h4>
                        </div>
                        <p class="text-lg text-dr-slate-600 leading-relaxed font-medium">
                            El sistema utiliza un tope semanal de <span
                                class="text-dr-blue font-black underline decoration-2 underline-offset-4">RD$
                                18,915.79</span> para el cálculo de las retenciones de AFP y ARS.
                            <span
                                class="block mt-4 text-sm font-bold text-dr-slate-400 uppercase tracking-wider italic">
                                * Valor determinado mediante estudio de casos reales en el sector privado y normativa
                                vigente de topes de cotización.
                            </span>
                        </p>
                    </div>
                </div>
            </div>

            <!-- Note: Disclaimer Section -->
            <div
                class="glass rounded-[3rem] p-10 neo-shadow border border-dr-red/20 bg-dr-red/[0.03] relative overflow-hidden group mt-8">
                <div
                    class="absolute top-0 right-0 w-64 h-64 bg-dr-red/5 rounded-full -mr-32 -mt-32 blur-3xl group-hover:bg-dr-red/10 transition-all duration-700">
                </div>
                <div class="relative z-10 flex flex-col md:flex-row items-center gap-10">
                    <div
                        class="w-24 h-24 shrink-0 rounded-[2rem] bg-dr-white flex items-center justify-center neo-shadow border border-dr-slate-100">
                        <svg class="w-12 h-12 text-dr-red" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z">
                            </path>
                        </svg>
                    </div>
                    <div>
                        <div class="flex items-center gap-3 mb-3">
                            <span class="w-2 h-6 bg-dr-red rounded-full"></span>
                            <h4 class="text-2xl font-black text-dr-slate-800 tracking-tight">Importante: Alcance del
                                Cálculo</h4>
                        </div>
                        <p class="text-lg text-dr-slate-600 leading-relaxed font-medium">
                            Impucalculo solo procesa las retenciones de ley: <span class="text-dr-blue font-black">ISR,
                                AFP y ARS</span>.
                            <br>
                            <span class="block mt-4 text-sm font-bold text-dr-slate-500 uppercase tracking-wider">
                                Descuentos corporativos internos (como <span
                                    class="text-dr-slate-700 underline decoration-dr-red/30 decoration-2 underline-offset-2">cafetería,
                                    préstamos, cooperativa o seguros adicionales</span>) <span class="text-dr-red">NO
                                    SON CALCULADOS</span> por este sistema.
                            </span>
                        </p>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <!-- Footer Ticker -->
    <footer class="py-6 glass border-t border-dr-slate-100 mt-20 overflow-hidden relative w-full">
        <!-- Ticker Wrapper -->
        <div
            class="w-full inline-flex flex-nowrap overflow-hidden [mask-image:_linear-gradient(to_right,transparent_0,_black_128px,_black_calc(100%-128px),transparent_100%)]">

            <!-- Grupo 1 -->
            <div class="flex items-center justify-center md:justify-start [&_div]:mx-8 animate-infinite-scroll">

                <!-- Item: Logo + Nombre -->
                <div class="flex items-center gap-4">
                    <img src="logo_new.png" alt="Logo" class="h-[100px] w-auto object-contain drop-shadow-md">
                    <div>
                        <p class="text-[10px] font-bold text-dr-slate-400 uppercase tracking-[0.2em]">Plataforma Fiscal
                            Premium</p>
                        <p class="text-sm font-extrabold text-dr-slate-800">Creado por: <span class="text-dr-blue">Lenin
                                Santana de Jesus</span></p>
                    </div>
                </div>

                <!-- Separador -->
                <div class="w-2 h-2 rounded-full bg-dr-slate-200"></div>

                <!-- Item: Año -->
                <div
                    class="px-6 py-2 bg-dr-white neo-shadow rounded-xl border border-dr-slate-100 flex items-center gap-3">
                    <span class="relative flex h-3 w-3">
                        <span
                            class="animate-ping absolute inline-flex h-full w-full rounded-full bg-dr-red opacity-75"></span>
                        <span class="relative inline-flex rounded-full h-3 w-3 bg-dr-red"></span>
                    </span>
                    <p class="text-xs font-black text-dr-slate-800 uppercase tracking-tighter">Año de Implementación:
                        <span class="text-dr-red">2025</span>
                    </p>
                </div>

                <!-- Separador -->
                <div class="w-2 h-2 rounded-full bg-dr-slate-200"></div>

                <!-- Item: Repetido para llenar espacio -->
                <div class="flex items-center gap-4">
                    <img src="logo_new.png" alt="Logo" class="h-[100px] w-auto object-contain drop-shadow-md">
                    <div>
                        <p class="text-[10px] font-bold text-dr-slate-400 uppercase tracking-[0.2em]">Plataforma Fiscal
                            Premium</p>
                        <p class="text-sm font-extrabold text-dr-slate-800">Creado por: <span class="text-dr-blue">Lenin
                                Santana de Jesus</span></p>
                    </div>
                </div>

                <!-- Separador -->
                <div class="w-2 h-2 rounded-full bg-dr-slate-200"></div>

                <!-- Item: Año Repetido -->
                <div
                    class="px-6 py-2 bg-dr-white neo-shadow rounded-xl border border-dr-slate-100 flex items-center gap-3">
                    <span class="w-2 h-2 rounded-full bg-dr-blue"></span>
                    <p class="text-xs font-black text-dr-slate-800 uppercase tracking-tighter">Gestión Fiscal: <span
                            class="text-dr-blue">Inteligente</span></p>
                </div>

            </div>

            <!-- Grupo 2 (Duplicado exacto para el loop infinito) -->
            <div class="flex items-center justify-center md:justify-start [&_div]:mx-8 animate-infinite-scroll"
                aria-hidden="true">

                <!-- Item: Logo + Nombre -->
                <div class="flex items-center gap-4">
                    <img src="logo_new.png" alt="Logo" class="h-[100px] w-auto object-contain drop-shadow-md">
                    <div>
                        <p class="text-[10px] font-bold text-dr-slate-400 uppercase tracking-[0.2em]">Plataforma Fiscal
                            Premium</p>
                        <p class="text-sm font-extrabold text-dr-slate-800">Creado por: <span class="text-dr-blue">Lenin
                                Santana de Jesus</span></p>
                    </div>
                </div>

                <!-- Separador -->
                <div class="w-2 h-2 rounded-full bg-dr-slate-200"></div>

                <!-- Item: Año -->
                <div
                    class="px-6 py-2 bg-dr-white neo-shadow rounded-xl border border-dr-slate-100 flex items-center gap-3">
                    <span class="relative flex h-3 w-3">
                        <span
                            class="animate-ping absolute inline-flex h-full w-full rounded-full bg-dr-red opacity-75"></span>
                        <span class="relative inline-flex rounded-full h-3 w-3 bg-dr-red"></span>
                    </span>
                    <p class="text-xs font-black text-dr-slate-800 uppercase tracking-tighter">Año de Implementación:
                        <span class="text-dr-red">2025</span>
                    </p>
                </div>

                <!-- Separador -->
                <div class="w-2 h-2 rounded-full bg-dr-slate-200"></div>

                <!-- Item: Repetido para llenar espacio -->
                <div class="flex items-center gap-4">
                    <img src="logo_new.png" alt="Logo" class="h-[50px] w-auto object-contain drop-shadow-md">
                    <div>
                        <p class="text-[10px] font-bold text-dr-slate-400 uppercase tracking-[0.2em]">Plataforma Fiscal
                            Premium</p>
                        <p class="text-sm font-extrabold text-dr-slate-800">Creado por: <span class="text-dr-blue">Lenin
                                Santana de Jesus</span></p>
                    </div>
                </div>

                <!-- Separador -->
                <div class="w-2 h-2 rounded-full bg-dr-slate-200"></div>

                <!-- Item: Año Repetido -->
                <div
                    class="px-6 py-2 bg-dr-white neo-shadow rounded-xl border border-dr-slate-100 flex items-center gap-3">
                    <span class="w-2 h-2 rounded-full bg-dr-blue"></span>
                    <p class="text-xs font-black text-dr-slate-800 uppercase tracking-tighter">Gestión Fiscal: <span
                            class="text-dr-blue">Inteligente</span></p>
                </div>

            </div>
        </div>
    </footer>

    <!-- Templates -->
    <template id="row-template">
        <tr class="group hover:bg-dr-blue/[0.02] transition-colors">
            <td class="px-8 py-6">
                <p class="text-xs font-black text-dr-slate-900 mb-1 date-val">05 ENE 2025</p>
                <span
                    class="freq-tag px-2 py-0.5 bg-dr-slate-100 text-[9px] font-black text-dr-slate-500 uppercase rounded-md">MENSUAL</span>
            </td>
            <td class="px-8 py-6">
                <p class="text-sm font-black text-dr-slate-800 gross-val">RD$ 0.00</p>
            </td>
            <td class="px-8 py-6">
                <div class="space-y-1">
                    <p class="text-[10px] font-bold text-dr-slate-400 flex items-center justify-between">AFP: <span
                            class="text-dr-slate-600 afp-val">RD$ 0.00</span></p>
                    <p class="text-[10px] font-bold text-dr-slate-400 flex items-center justify-between">ARS: <span
                            class="text-dr-slate-600 ars-val">RD$ 0.00</span></p>
                    <div class="h-px bg-dr-slate-100 my-1"></div>
                    <p class="text-[10px] font-bold text-dr-slate-800 flex items-center justify-between">ISR: <span
                            class="text-dr-red isr-val">RD$ 0.00</span></p>
                </div>
            </td>
            <td class="px-8 py-6 text-right">
                <div class="flex flex-col items-end gap-2">
                    <p class="text-lg font-black text-dr-blue net-val leading-none">RD$ 0.00</p>
                    <div class="accum-badge hidden">
                        <span class="px-2 py-0.5 bg-dr-blue/10 text-dr-blue text-[8px] font-black uppercase rounded">Mes
                            Acumulado</span>
                    </div>
                    <button class="delete-btn p-2 text-dr-slate-300 hover:text-dr-red transition-colors"
                        title="Borrar registro">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16">
                            </path>
                        </svg>
                    </button>
                </div>
            </td>
        </tr>
    </template>

    <script>
        const CONFIG = {
            SMN: 21674.80,
            MONTHLY_EXEMPT: 34685.00,
            ANNUAL_EXEMPT: 416220.00,
            TSS_RATES: {
                SFS: 0.0304,
                AFP: 0.0287
            },
            TSS_CAPS: {
                SFS: 10,
                AFP: 20
            },
            MONTHLY_BRACKETS: [
                { limit: 72260.25, rate: 0.25, fixed: 6648.00, base: 72260.25 },
                { limit: 52027.42, rate: 0.20, fixed: 2601.33, base: 52027.42 },
                { limit: 34685.00, rate: 0.15, fixed: 0, base: 34685.00 }
            ]
        };

        const STORAGE_KEY = 'impucalculo_data_v3';
        const FIXED_SALARY_KEY = 'impucalculo_fixed_salary';
        let state = JSON.parse(localStorage.getItem(STORAGE_KEY)) || { records: [] };
        let fixedSalaryConfig = JSON.parse(localStorage.getItem(FIXED_SALARY_KEY)) || { enabled: false, amount: '' };

        const fmt = new Intl.NumberFormat('es-DO', { style: 'currency', currency: 'DOP' });
        const fmtDate = (d) => {
            const date = new Date(d + 'T00:00:00');
            return date.toLocaleDateString('es-DO', { day: '2-digit', month: 'short', year: 'numeric' })
                .toUpperCase()
                .replace('.', '')
                .replace(/ DE /g, ' ');
        };

        const getMonthYear = (d) => {
            const date = new Date(d + 'T00:00:00');
            return `${date.getMonth() + 1}-${date.getFullYear()}`;
        };

        const elements = {
            form: document.getElementById('tax-form'),
            dateInput: document.getElementById('input-date'),
            weeklyIncomeInput: document.getElementById('weekly-income'),

            tssBasePreview: document.getElementById('tss-base-preview'),
            afpPreview: document.getElementById('afp-preview'),
            arsPreview: document.getElementById('ars-preview'),

            displayDate: document.getElementById('display-date'), /* Added display element */

            mtdAfp: document.getElementById('mtd-afp'),
            mtdArs: document.getElementById('mtd-ars'),
            mtdIsr: document.getElementById('mtd-isr'),
            mtdNet: document.getElementById('mtd-net'),
            mtdTaxable: document.getElementById('mtd-taxable'),
            mtdProgressBar: document.getElementById('mtd-progress-bar'),
            mtdProgressText: document.getElementById('mtd-progress-text'),
            labelMesActual: document.getElementById('label-mes-actual'),
            historyRows: document.getElementById('history-rows'),
            emptyState: document.getElementById('empty-state'),
            btnClear: document.getElementById('clear-history')
        };

        // Lógica del Modal Sueldo Fijo
        function openFixedSalaryModal() {
            const modal = document.getElementById('modal-sueldo-fijo');
            const input = document.getElementById('modal-fixed-salary-input');

            if (modal && input) {
                // Cargar valor actual
                input.value = fixedSalaryConfig.amount || '';

                modal.classList.remove('hidden');
                modal.classList.add('flex');

                // Enfocar input si está vacío
                if (!input.value) {
                    setTimeout(() => input.focus(), 100);
                }
            }
        }

        function closeFixedSalaryModal() {
            const modal = document.getElementById('modal-sueldo-fijo');
            if (modal) {
                modal.classList.add('hidden');
                modal.classList.remove('flex');
            }
        }

        function saveFixedSalary() {
            const input = document.getElementById('modal-fixed-salary-input');
            const amount = parseFloat(input.value);

            if (amount && amount > 0) {
                fixedSalaryConfig = { enabled: true, amount: amount };
                localStorage.setItem(FIXED_SALARY_KEY, JSON.stringify(fixedSalaryConfig));

                // Actualizar interfaz principal
                // indicator removed

                // Cerrar modal
                closeFixedSalaryModal();

                // Recalcular si hay datos
                if (elements.weeklyIncomeInput.value) {
                    updatePreview();
                }
            } else {
                alert('Por favor introduce un monto válido mayor a 0 para activar el sueldo fijo, o presiona Eliminar.');
            }
        }

        function deleteFixedSalary() {
            fixedSalaryConfig = { enabled: false, amount: '' };
            localStorage.setItem(FIXED_SALARY_KEY, JSON.stringify(fixedSalaryConfig));
            // indicator removed
            closeFixedSalaryModal();
            if (elements.weeklyIncomeInput.value) {
                updatePreview();
            }
        }


        // Cálculo correcto de TSS según ley dominicana (Resolución 72-03 CNSS)
        // Las horas extras NO se gravan con AFP/ARS
        // freq: solo se usa para prorratear cuando hay sueldo fijo mensual
        const calculateTSS = (grossIncome, fixedSalary = null, freq = 'MENSUAL') => {
            // Aplicar topes mensuales
            const sfsCap = CONFIG.SMN * CONFIG.TSS_CAPS.SFS;
            const afpCap = CONFIG.SMN * CONFIG.TSS_CAPS.AFP;

            if (fixedSalary !== null) {
                // Sueldo fijo es MENSUAL → prorratear usando la fórmula anualizada para precisión
                // Semanal: (Mensual * 12) / 52
                // Quincenal: (Mensual * 12) / 24

                // Calcular TSS mensual completo
                const monthlySfs = Math.min(fixedSalary, sfsCap) * CONFIG.TSS_RATES.SFS;
                const monthlyAfp = Math.min(fixedSalary, afpCap) * CONFIG.TSS_RATES.AFP;

                let sfs, afp, tssBase;

                if (freq === 'SEMANAL') {
                    sfs = (monthlySfs * 12) / 52;
                    afp = (monthlyAfp * 12) / 52;
                    tssBase = (fixedSalary * 12) / 52;
                } else if (freq === 'QUINCENAL') {
                    sfs = (monthlySfs * 12) / 24;
                    afp = (monthlyAfp * 12) / 24;
                    tssBase = (fixedSalary * 12) / 24;
                } else {
                    // Mensual
                    sfs = monthlySfs;
                    afp = monthlyAfp;
                    tssBase = fixedSalary;
                }

                return { sfs, afp, tssBase };
            } else {
                // Sin sueldo fijo → el ingreso bruto ya es del período (semanal/quincenal/mensual)
                const tssBase = grossIncome;
                // Nota: Sin sueldo fijo, los topes se aplican directamente al periodo actual, 
                // lo cual es una aproximación si el ingreso varía mucho. 
                // Pero es el comportamiento estándar si no hay sueldo base definido.
                // Ajustamos los topes a la frecuencia para ser consistentes

                let sfsCapAdj = sfsCap;
                let afpCapAdj = afpCap;

                if (freq === 'SEMANAL') {
                    sfsCapAdj = (sfsCap * 12) / 52;
                    afpCapAdj = (afpCap * 12) / 52;
                } else if (freq === 'QUINCENAL') {
                    sfsCapAdj = (sfsCap * 12) / 24;
                    afpCapAdj = (afpCap * 12) / 24;
                }

                const sfs = Math.min(tssBase, sfsCapAdj) * CONFIG.TSS_RATES.SFS;
                const afp = Math.min(tssBase, afpCapAdj) * CONFIG.TSS_RATES.AFP;
                return { sfs, afp, tssBase };
            }
        };

        const calculateMonthlyISR = (monthlyTaxable) => {
            if (monthlyTaxable <= CONFIG.MONTHLY_EXEMPT) return 0;
            const bracket = CONFIG.MONTHLY_BRACKETS.find(b => monthlyTaxable >= b.limit);
            if (!bracket) return 0;
            return bracket.fixed + ((monthlyTaxable - bracket.base) * bracket.rate);
        };

        const updateDashboard = () => {
            const today = elements.dateInput.value;
            const currentMonthYear = getMonthYear(today);
            const currentMonthRecords = state.records.filter(r => getMonthYear(r.date) === currentMonthYear);

            const totalGross = currentMonthRecords.reduce((sum, r) => sum + r.gross, 0);
            const totalAfp = currentMonthRecords.reduce((sum, r) => sum + r.afp, 0);
            const totalArs = currentMonthRecords.reduce((sum, r) => sum + r.ars, 0);
            const totalIsr = currentMonthRecords.reduce((sum, r) => sum + r.isr, 0);

            const totalTaxable = totalGross - (totalAfp + totalArs);
            const totalNet = totalGross - (totalAfp + totalArs) - totalIsr;

            elements.mtdAfp.innerText = fmt.format(totalAfp);
            elements.mtdArs.innerText = fmt.format(totalArs);
            elements.mtdIsr.innerText = fmt.format(totalIsr);
            elements.mtdNet.innerText = fmt.format(totalNet);
            elements.mtdTaxable.innerText = fmt.format(totalTaxable);

            const dateObj = new Date(today + 'T00:00:00');
            elements.labelMesActual.innerText = dateObj.toLocaleDateString('es-DO', { month: 'long', year: 'numeric' }).toUpperCase();

            const progress = Math.min((totalTaxable / CONFIG.MONTHLY_EXEMPT) * 100, 100);
            elements.mtdProgressBar.style.width = `${progress}%`;
            elements.mtdProgressText.innerText = `${progress.toFixed(1)}% del umbral mensual alcanzado`;

            if (totalTaxable > CONFIG.MONTHLY_EXEMPT) {
                elements.mtdProgressBar.classList.replace('bg-dr-blue', 'bg-dr-red');
            } else {
                elements.mtdProgressBar.classList.replace('bg-dr-red', 'bg-dr-blue');
            }
        };

        const renderHistory = () => {
            elements.historyRows.innerHTML = '';
            if (state.records.length === 0) {
                elements.emptyState.classList.remove('hidden');
                return;
            }
            elements.emptyState.classList.add('hidden');

            [...state.records].sort((a, b) => new Date(b.date) - new Date(a.date)).forEach(record => {
                const template = document.getElementById('row-template').content.cloneNode(true);
                template.querySelector('.date-val').innerText = fmtDate(record.date);
                template.querySelector('.freq-tag').innerText = record.freq;
                template.querySelector('.gross-val').innerText = fmt.format(record.gross);
                template.querySelector('.afp-val').innerText = fmt.format(record.afp);
                template.querySelector('.ars-val').innerText = fmt.format(record.ars);
                template.querySelector('.isr-val').innerText = fmt.format(record.isr);
                template.querySelector('.net-val').innerText = fmt.format(record.net);

                const currentMonth = getMonthYear(elements.dateInput.value);
                if (getMonthYear(record.date) === currentMonth) {
                    template.querySelector('.accum-badge').classList.remove('hidden');
                }

                // Delete handle
                template.querySelector('.delete-btn').onclick = () => {
                    if (confirm('¿Borrar este registro?')) {
                        state.records = state.records.filter(r => r.id !== record.id);
                        localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
                        updateDashboard();
                        renderHistory();
                    }
                };

                elements.historyRows.appendChild(template);
            });
        };

        // Obtener frecuencia seleccionada
        const getSelectedFreq = () => {
            const radio = Array.from(document.getElementsByName('freq')).find(r => r.checked);
            return radio ? radio.value.toUpperCase() : 'SEMANAL';
        };

        // Preview en tiempo real
        const updatePreview = () => {
            const income = parseFloat(elements.weeklyIncomeInput.value) || 0;
            const fixedAmt = parseFloat(fixedSalaryConfig.amount) || 0;
            // Si el monto es 0 o inválido, tratamos como si no hubiera sueldo fijo (usando null para fallback)
            const fixedSalary = (fixedSalaryConfig.enabled && fixedAmt > 0) ? fixedAmt : null;
            const freq = getSelectedFreq();
            const { afp, sfs, tssBase } = calculateTSS(income, fixedSalary, freq);

            elements.tssBasePreview.innerText = fmt.format(tssBase);
            elements.afpPreview.innerText = fmt.format(afp);
            elements.arsPreview.innerText = fmt.format(sfs);
        };

        elements.weeklyIncomeInput.addEventListener('input', updatePreview);



        // Update labels when frequency changes
        const freqLabels = { semanal: 'Semanal', quincenal: 'Quincenal', mensual: 'Mensual' };
        document.querySelectorAll('input[name="freq"]').forEach(radio => {
            radio.addEventListener('change', () => {
                const selected = freqLabels[radio.value] || 'Semanal';
                document.getElementById('income-label').textContent = `Ingreso ${selected} Bruto`;
                document.getElementById('income-help').textContent = `Monto total ${selected.toLowerCase()} según tu volante de pago.`;
                updatePreview(); // Recalcular TSS con nueva frecuencia
            });
        });

        elements.form.addEventListener('submit', (e) => {
            e.preventDefault();
            const date = elements.dateInput.value;
            const gross = parseFloat(elements.weeklyIncomeInput.value) || 0;
            const fixedAmt = parseFloat(fixedSalaryConfig.amount) || 0;
            // Si el monto es 0 o inválido, tratamos como si no hubiera sueldo fijo
            const fixedSalary = (fixedSalaryConfig.enabled && fixedAmt > 0) ? fixedAmt : null;
            const freq = getSelectedFreq();

            // Calcular TSS prorrateado según frecuencia
            const { afp, sfs, tssBase } = calculateTSS(gross, fixedSalary, freq);
            const ars = sfs; // Renombrar para consistencia

            const monthYear = getMonthYear(date);
            const prevRecords = state.records.filter(r => getMonthYear(r.date) === monthYear);
            const prevGross = prevRecords.reduce((sum, r) => sum + r.gross, 0);
            const prevTss = prevRecords.reduce((sum, r) => sum + (r.afp + r.ars), 0);
            const prevIsr = prevRecords.reduce((sum, r) => sum + r.isr, 0);

            // ISR se calcula sobre el acumulado del mes (ingreso total neto de TSS)
            const currentMonthTaxable = (prevGross + gross) - (prevTss + (afp + ars));

            // Si el acumulado es menor al límite mensual (34,685), ISR es 0
            const totalIsrFullMonth = calculateMonthlyISR(currentMonthTaxable);
            const isr = Math.max(0, totalIsrFullMonth - prevIsr);
            const net = gross - (afp + ars) - isr;

            state.records.unshift({
                id: Date.now(), date, freq, gross, tssBase, afp, ars, isr, net
            });

            localStorage.setItem(STORAGE_KEY, JSON.stringify(state));

            updateDashboard();
            renderHistory();

            // Limpiar formulario
            elements.weeklyIncomeInput.value = '';

            elements.tssBasePreview.innerText = 'RD$ 0.00';
            elements.afpPreview.innerText = 'RD$ 0.00';
            elements.arsPreview.innerText = 'RD$ 0.00';

            document.getElementById('block-resumen').scrollIntoView({ behavior: 'smooth', block: 'center' });
        });

        // Date Display Logic
        const updateDateDisplay = () => {
            const isoDate = elements.dateInput.value;
            if (isoDate) {
                const [y, m, d] = isoDate.split('-');
                elements.displayDate.value = `${d}/${m}/${y}`;
            } else {
                elements.displayDate.value = '';
            }
        };

        elements.dateInput.addEventListener('change', () => {
            updateDateDisplay();
            updateDashboard();
            renderHistory();
        });

        /* Sync on input also for immediate feedback on some browsers */
        elements.dateInput.addEventListener('input', updateDateDisplay);

        // Gestión de historial de cálculos
        function clearHistory() {
            localStorage.removeItem(STORAGE_KEY);
            // NO borramos la configuración de sueldo fijo (para que el usuario no tenga que reescribirlo)
            // Pero sí queremos que el modal salte de nuevo para confirmar.
            // Usamos sessionStorage para forzar la apertura del modal en la recarga.
            sessionStorage.setItem('force_salary_modal', 'true');

            // Recargamos la página
            location.reload();
        }

        elements.btnClear.addEventListener('click', () => {
            if (confirm('¿Eliminar todo el historial?')) {
                clearHistory();
            }
        });

        // Init
        const initMain = () => {
            const today = new Date().toISOString().split('T')[0];
            elements.dateInput.value = today;
            updateDateDisplay(); /* Initial update */


            // Restaurar indicador (ya no existe)


            // Mostrar modal de sueldo fijo si:
            // 1. No existe configuración (Usuario nuevo)
            // 2. Se forzó la apertura desde "Limpiar Todo" (sessionStorage)
            if (!localStorage.getItem(FIXED_SALARY_KEY) || sessionStorage.getItem('force_salary_modal')) {
                // Limpiar la bandera de forzado
                sessionStorage.removeItem('force_salary_modal');

                // Marcar como visto (para consistencia)
                localStorage.setItem('impucalculo_fixed_salary_seen', '1');

                // Abrir modal con delay
                setTimeout(() => openFixedSalaryModal(), 500);
            }

            updateDashboard();
            renderHistory();
        };

        window.onload = initMain;
    </script>


    <!-- Modal de Sueldo Fijo -->
    <div id="modal-sueldo-fijo" class="fixed inset-0 z-[150] hidden items-center justify-center p-4">
        <!-- Backdrop -->
        <div class="absolute inset-0 bg-dr-slate-900/40 backdrop-blur-sm transition-opacity"
            onclick="closeFixedSalaryModal()"></div>

        <!-- Modal Content -->
        <div class="relative w-full max-w-md bg-white rounded-3xl shadow-2xl p-8 space-y-6 z-10">
            <button onclick="closeFixedSalaryModal()"
                class="absolute top-4 right-4 w-8 h-8 flex items-center justify-center rounded-full bg-dr-slate-100 hover:bg-dr-slate-200 transition-colors">
                <span class="text-dr-slate-500 text-lg">✕</span>
            </button>

            <div class="text-center space-y-2">
                <h3 class="text-lg font-black">
                    <span class="text-dr-blue">¿Cobras</span> <span class="text-dr-red">Horas Extras</span><span
                        class="text-dr-blue">?</span>
                </h3>
                <p class="text-xs text-dr-slate-500 font-bold leading-relaxed">
                    Si te pagan horas extras, introduce tu <span class="text-dr-blue font-black">sueldo base fijo
                        mensual</span> <span class="text-dr-red font-black">(sin extras)</span>. Así, ARS y AFP se
                    calcularán correctamente sobre tu salario base.
                </p>
            </div>

            <!-- Input -->
            <div class="space-y-2">
                <label class="block text-xs font-black text-dr-blue uppercase tracking-widest">Sueldo Fijo Mensual <span
                        class="text-dr-red">(Sin Extras)</span></label>
                <div class="relative">
                    <div class="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none">
                        <span class="text-dr-blue font-bold">RD$</span>
                    </div>
                    <input type="number" id="modal-fixed-salary-input" step="0.01" min="0" placeholder="Ej: 15,000.00"
                        class="w-full pl-12 pr-4 py-4 bg-white border-2 border-dr-blue/30 rounded-2xl text-xl font-black text-dr-slate-900 focus:border-dr-blue outline-none transition-all">
                </div>
            </div>

            <!-- Botones -->
            <div class="flex gap-3">
                <button type="button" onclick="deleteFixedSalary()"
                    class="flex-1 py-3 rounded-2xl border-2 border-dr-red/30 text-dr-red text-xs font-black uppercase tracking-widest hover:bg-dr-red/5 transition-colors">
                    Eliminar
                </button>
                <button type="button" onclick="saveFixedSalary()"
                    class="flex-1 py-3 rounded-2xl bg-dr-blue text-white text-xs font-black uppercase tracking-widest hover:bg-dr-blue-600 transition-colors shadow-lg">
                    Guardar
                </button>
            </div>
        </div>
    </div>

    <!-- Modal de Sugerencias -->
    <div id="modal-sugerencias" class="fixed inset-0 z-[100] hidden items-center justify-center p-4">
        <!-- Backdrop -->
        <div class="absolute inset-0 bg-dr-slate-900/40 backdrop-blur-sm transition-opacity"
            onclick="closeSuggestionsModal()"></div>

        <!-- Modal Content -->
        <div
            class="glass relative w-full max-w-lg rounded-[2.5rem] p-8 neo-shadow border border-white animate-slide-up">
            <button onclick="closeSuggestionsModal()"
                class="absolute top-6 right-6 text-dr-slate-400 hover:text-dr-red transition-colors">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12">
                    </path>
                </svg>
            </button>

            <div class="flex items-center gap-4 mb-6">
                <div class="w-12 h-12 rounded-2xl bg-dr-blue/10 flex items-center justify-center text-dr-blue">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z">
                        </path>
                    </svg>
                </div>
                <div>
                    <h2 class="text-2xl font-black tracking-tight"><span class="text-dr-blue">Tu Feedback</span> <span
                            class="text-dr-red">importa</span></h2>
                    <p class="text-xs font-bold text-dr-slate-800 uppercase tracking-widest">Ayúdanos a mejorar
                        Impucálculo</p>
                </div>
            </div>

            <form id="form-sugerencias" class="space-y-6">
                <div id="feedback-success"
                    class="hidden p-4 bg-green-50 text-green-700 rounded-2xl border border-green-100 text-center font-bold animate-fade-in">
                    ¡Gracias! Tu sugerencia ha sido recibida. ✨
                </div>

                <div class="space-y-4" id="feedback-fields">
                    <div>
                        <label
                            class="block text-[10px] font-black text-dr-slate-800 uppercase tracking-widest mb-2">Nombre
                            (Opcional)</label>
                        <input type="text" id="feedback-name" placeholder="Tu nombre"
                            class="w-full px-5 py-4 bg-dr-slate-50 border-2 border-dr-slate-100 rounded-2xl text-dr-slate-900 font-bold focus:border-dr-blue outline-none transition-all">
                    </div>
                    <div>
                        <label class="block text-[10px] font-black text-dr-slate-800 uppercase tracking-widest mb-2">Tu
                            Sugerencia</label>
                        <textarea id="feedback-message" required rows="4"
                            placeholder="¿Cómo podemos mejorar la aplicación?"
                            class="w-full px-5 py-4 bg-white border-2 border-dr-blue/20 rounded-2xl text-dr-slate-900 font-bold focus:border-dr-blue outline-none transition-all resize-none"></textarea>
                    </div>
                    <button type="submit"
                        class="w-full py-5 rounded-[1.5rem] btn-gradient-blue text-white font-black text-lg uppercase tracking-widest hover:scale-[1.02] transition-transform">
                        Enviar Sugerencia
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // Funciones para el Modal de Sugerencias
        const modal = document.getElementById('modal-sugerencias');
        const suggestBtn = document.getElementById('btn-sugerencias');
        const feedbackForm = document.getElementById('form-sugerencias');
        const feedbackFields = document.getElementById('feedback-fields');
        const feedbackSuccess = document.getElementById('feedback-success');

        // REEMPLAZA ESTA URL CON LA DE TU GOOGLE APPS SCRIPT
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbweavYg0Hu3kftiPB58R07F4bV0jHInti62LfBk5wx7I_TblYv-vBnMsciKwpTwxHL9/exec';

        function openSuggestionsModal() {
            modal.classList.remove('hidden');
            modal.classList.add('flex');
            document.body.style.overflow = 'hidden';
            feedbackFields.classList.remove('hidden');
            feedbackSuccess.classList.add('hidden');
            feedbackForm.reset();
        }

        function closeSuggestionsModal() {
            modal.classList.add('hidden');
            modal.classList.remove('flex');
            document.body.style.overflow = '';
        }

        if (suggestBtn) {
            suggestBtn.addEventListener('click', openSuggestionsModal);
        }

        if (feedbackForm) {
            feedbackForm.addEventListener('submit', function (e) {
                e.preventDefault();

                // Evitar doble envío
                const submitBtn = feedbackForm.querySelector('button[type="submit"]');
                const originalBtnText = submitBtn.innerText;
                submitBtn.disabled = true;
                submitBtn.innerText = 'Enviando...';
                submitBtn.classList.add('opacity-50', 'cursor-not-allowed');

                // Recopilar datos
                const name = document.getElementById('feedback-name').value;
                const message = document.getElementById('feedback-message').value;

                // Enviar a Google Sheets
                fetch(SCRIPT_URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        name: name,
                        message: message,
                        source: 'Calculadora Impuestos (index.html)'
                    })
                }).then(() => {
                    feedbackFields.classList.add('hidden');
                    feedbackSuccess.classList.remove('hidden');
                    setTimeout(() => {
                        closeSuggestionsModal();
                        // Resetear botón después de cerrar
                        submitBtn.disabled = false;
                        submitBtn.innerText = originalBtnText;
                        submitBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                    }, 2500);
                }).catch(error => {
                    console.error('Error:', error);
                    alert('Hubo un error al enviar tu sugerencia.');
                    // Resetear botón en caso de error
                    submitBtn.disabled = false;
                    submitBtn.innerText = originalBtnText;
                    submitBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                });
            });
        }
    </script>
</body>

</html>